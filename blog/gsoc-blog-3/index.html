<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>jpy794</title><meta charset=utf-8><meta name=description content="Ladder@Long time no see! It&rsquo;s time to share my progress on the GSoC project. Last time we manually built a netboot SD card image for RPi 3B+ and left some questions to be answered. Now let&rsquo;s dig into those questions and show you what I&rsquo;ve got.
Boot2ipxe First, a new project, Boot2ipxe, is created for building and testing iPXE netboot disk image for both SBCs and x86 PC, which used to be part of ipxe-boot-server&rsquo;s job."><meta name=author content="jpy794"><link rel=canonical href=https://jpy794.github.io/blog/gsoc-blog-3/><meta name=google-site-verification content="hkf8Kk9sh38Hm5TzNLXjKJ-Mb3LCSX4b9e4OZ56KXtw"><meta property="og:title" content="Run Boot2container on RPi - GSoC '23"><meta property="og:description" content="Long time no see! It&rsquo;s time to share my progress on the GSoC project. Last time we manually built a netboot SD card image for RPi 3B+ and left some questions to be answered. Now let&rsquo;s dig into those questions and show you what I&rsquo;ve got.
Boot2ipxe First, a new project, Boot2ipxe, is created for building and testing iPXE netboot disk image for both SBCs and x86 PC, which used to be part of ipxe-boot-server&rsquo;s job."><meta property="og:type" content="article"><meta property="og:url" content="https://jpy794.github.io/blog/gsoc-blog-3/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-09-03T16:23:29+08:00"><meta property="article:modified_time" content="2023-09-03T16:23:29+08:00"><meta property="og:see_also" content="https://jpy794.github.io/blog/gsoc-blog-2/"><meta property="og:see_also" content="https://jpy794.github.io/blog/gsoc-blog-1/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Run Boot2container on RPi - GSoC '23"><meta name=twitter:description content="Long time no see! It&rsquo;s time to share my progress on the GSoC project. Last time we manually built a netboot SD card image for RPi 3B+ and left some questions to be answered. Now let&rsquo;s dig into those questions and show you what I&rsquo;ve got.
Boot2ipxe First, a new project, Boot2ipxe, is created for building and testing iPXE netboot disk image for both SBCs and x86 PC, which used to be part of ipxe-boot-server&rsquo;s job."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://jpy794.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Run Boot2container on RPi - GSoC '23","item":"https://jpy794.github.io/blog/gsoc-blog-3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Run Boot2container on RPi - GSoC '23","name":"Run Boot2container on RPi - GSoC \u002723","description":"Long time no see! It\u0026rsquo;s time to share my progress on the GSoC project. Last time we manually built a netboot SD card image for RPi 3B+ and left some questions to be answered. Now let\u0026rsquo;s dig into those questions and show you what I\u0026rsquo;ve got.\nBoot2ipxe First, a new project, Boot2ipxe, is created for building and testing iPXE netboot disk image for both SBCs and x86 PC, which used to be part of ipxe-boot-server\u0026rsquo;s job.","keywords":["gsoc"],"articleBody":"Long time no see! It’s time to share my progress on the GSoC project. Last time we manually built a netboot SD card image for RPi 3B+ and left some questions to be answered. Now let’s dig into those questions and show you what I’ve got.\nBoot2ipxe First, a new project, Boot2ipxe, is created for building and testing iPXE netboot disk image for both SBCs and x86 PC, which used to be part of ipxe-boot-server’s job.\nBoot2ipxe allows you to build and customize iPXE netboot disk image easily with a single make command. If you’re not familiar with your SBC’s boot process and just need a working iPXE disk image, make sure to check the link above. There’re both prebuilt images and guides to built them yourself with more flexibility.\nBesides, ipxe-boot-server now depends on boot2ipxe to generate disk image for gateways, which means it should support any device that boot2ipxe supports.\nRun Boot2container with Boot2ipxe Ref: https://gitlab.freedesktop.org/mupuf/netboot2container\nWith boot2ipxe, we can boot boot2container with netboot easily. All we need to do is to set up a netboot server, which can be achived in many ways, such as\nReuse the https server in the last post Set up a local http server Set up a DHCP server Here I choose the last one, as it’s boot2ipxe’s default behavior to boot from local DHCP server. We can use prebuilt boot2ipxe image instead of builing our own to embed our http/https server address in the image.\nAbout how to flash the image, please refer to README of boot2ipxe.\nNow let’s set up the DHCP server.\nInstall dnsmasq before moving on.\nIn the following steps, I’ll assume you have a RPi connected to the network interface naming ${lan_if}, and your gateway interface is ${wan_if}.\nThe first step is to assign an IP address to ${lan_if}.\nsudo ip addr add dev ${lan_if} 10.0.0.1/24 Now let’s set up IP forward and NAT.\nsudo sysctl net.ipv4.ip_forward=1 sudo nft add table nat sudo nft add chain nat postrouting { type nat hook postrouting priority 100 \\; } sudo nft add rule nat postrouting ip saddr 10.0.0.0/24 oifname ${wan_if} masquerade You need create a tftp folder under the path you gonna run dnsmasq, as root folder of the netboot server. In the tftp folder, create an iPXE script boot.ipxe and put boot2container kernel and initramfs there (You can download them from boot2container release). Remember to replace ${kernel} and ${b2c_initramfs} with correct filename.\n#!ipxe kernel /${kernel} initrd=b2c b2c.run=\"-ti docker.io/library/alpine:latest\" b2c.ntp_peer=auto initrd --name b2c /${b2c_initramfs} boot Then we’re ready to start DHCP server.\nsudo dnsmasq --port=0 \\ --conf-file=/dev/null \\ --dhcp-leasefile=$(pwd)/dnsmasq.leases \\ --dhcp-boot=/boot.ipxe \\ --dhcp-range=10.0.0.2,10.0.0.254 \\ --dhcp-option=option:dns-server,1.1.1.1 \\ --interface=${lan_if} \\ --enable-tftp=${lan_if} \\ --tftp-root=$(pwd)/tftp \\ --no-daemon You can boot up your RPi now. After spending time pulling Docker image etc., the RPi should output something in the end like\n+ podman start -a 5d85155c5ed80ebc85badf45766db7e33be2b5c12c0292025fed28f6d7fb1391 / # You’ve booted your RPi into boot2container with a prebuilt iPXE disk image from boot2ipxe!\nIf you’re using RPi 3B+, don’t worry if boot2container complains about no available network interface and fails to start Apline Linux. There’s a known mainline kernel issue for RPi 3B+. Mupuf found a workaround to temporarily disable usb_onboard_hub before it’s properly fixed. But currently the kernel downloaded from boot2container release above is still broken.\n","wordCount":"542","inLanguage":"en","datePublished":"2023-09-03T16:23:29+08:00","dateModified":"2023-09-03T16:23:29+08:00","author":{"@type":"Person","name":"jpy794"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jpy794.github.io/blog/gsoc-blog-3/"},"publisher":{"@type":"Organization","name":"jpy794","logo":{"@type":"ImageObject","url":"https://jpy794.github.io/favicon.ico"}}}</script><link rel=icon type=image/png href=/images/avatar.png sizes=16x16><link rel=apple-touch-icon href=/images/avatar.png><link rel=manifest href=/images/avatar.png><link rel=stylesheet href=/css/main.min.64bc8c4cb2304e84167c1583fa1b5de80f6d5adc95abed2e616dea0ea5680e01.css integrity="sha256-ZLyMTLIwToQWfBWD+htd6A9tWtyVq+0uYW3qDqVoDgE=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.872dfd2cd00064018a833a6e8e77a0fbf8fbac159546f2f205d4dad79a5d8e15.js></script>
<script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/blog>Blog</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archives</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/jpy794><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://jpy794.github.io/zh/>中</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Run Boot2container on RPi - GSoC '23</h1></header><p><small>September 3, 2023&nbsp;· 542 words&nbsp;· 3 min</small>
<small>·
<a href=https://jpy794.github.io/tags/gsoc/>gsoc</a></small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#boot2ipxe>Boot2ipxe</a></li><li><a href=#run-boot2container-with-boot2ipxe>Run Boot2container with Boot2ipxe</a></li></ul></nav></div><section class=blog-content><p>Long time no see! It&rsquo;s time to share my progress on the GSoC project.
Last time we manually built a netboot SD card image for RPi 3B+ and left some questions to be answered.
Now let&rsquo;s dig into those questions and show you what I&rsquo;ve got.</p><h2 id=boot2ipxe>Boot2ipxe</h2><p>First, a new project, <a href=https://gitlab.freedesktop.org/mupuf/boot2ipxe>Boot2ipxe</a>, is created for building and testing iPXE netboot disk image for both SBCs and x86 PC,
which used to be part of <a href=https://gitlab.freedesktop.org/mupuf/valve-infra/-/tree/master/ipxe-boot-server>ipxe-boot-server</a>&rsquo;s job.</p><p>Boot2ipxe allows you to build and customize iPXE netboot disk image easily with a single <code>make</code> command.
If you&rsquo;re not familiar with your SBC&rsquo;s boot process and just need a working iPXE disk image, make sure to check
the link above. There&rsquo;re both prebuilt images and guides to built them yourself with more flexibility.</p><p>Besides, ipxe-boot-server now depends on boot2ipxe to generate disk image for gateways,
which means it should support any device that boot2ipxe supports.</p><h2 id=run-boot2container-with-boot2ipxe>Run Boot2container with Boot2ipxe</h2><blockquote><p>Ref: <a href=https://gitlab.freedesktop.org/mupuf/netboot2container>https://gitlab.freedesktop.org/mupuf/netboot2container</a></p></blockquote><p>With boot2ipxe, we can boot <a href=https://gitlab.freedesktop.org/mupuf/boot2container>boot2container</a> with netboot easily. All we need to do is to set up a netboot server, which can be achived in many ways, such as</p><ul><li>Reuse the https server in the last post</li><li>Set up a local http server</li><li>Set up a DHCP server</li></ul><p>Here I choose the last one, as it&rsquo;s boot2ipxe&rsquo;s default behavior to boot from local DHCP server.
We can use prebuilt boot2ipxe image instead of builing our own to embed our http/https server address in the image.</p><p>About how to flash the image, please refer to README of boot2ipxe.</p><p>Now let&rsquo;s set up the DHCP server.</p><p>Install <code>dnsmasq</code> before moving on.</p><p>In the following steps, I&rsquo;ll assume you have a RPi connected to the network interface naming <code>${lan_if}</code>,
and your gateway interface is <code>${wan_if}</code>.</p><p>The first step is to assign an IP address to <code>${lan_if}</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ip addr add dev <span style=color:#e6db74>${</span>lan_if<span style=color:#e6db74>}</span> 10.0.0.1/24
</span></span></code></pre></div><p>Now let&rsquo;s set up IP forward and NAT.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo sysctl net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo nft add table nat
</span></span><span style=display:flex><span>sudo nft add chain nat postrouting <span style=color:#f92672>{</span> type nat hook postrouting priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo nft add rule nat postrouting ip saddr 10.0.0.0/24 oifname <span style=color:#e6db74>${</span>wan_if<span style=color:#e6db74>}</span> masquerade
</span></span></code></pre></div><p>You need create a <code>tftp</code> folder under the path you gonna run <code>dnsmasq</code>, as root folder of the netboot server.
In the <code>tftp</code> folder, create an iPXE script <code>boot.ipxe</code> and put boot2container kernel and initramfs there
(You can download them from <a href=https://gitlab.freedesktop.org/mupuf/boot2container/-/releases>boot2container release</a>).
Remember to replace <code>${kernel}</code> and <code>${b2c_initramfs}</code> with correct filename.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!ipxe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>kernel /<span style=color:#e6db74>${</span>kernel<span style=color:#e6db74>}</span> initrd<span style=color:#f92672>=</span>b2c b2c.run<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-ti docker.io/library/alpine:latest&#34;</span> b2c.ntp_peer<span style=color:#f92672>=</span>auto
</span></span><span style=display:flex><span>initrd --name b2c /<span style=color:#e6db74>${</span>b2c_initramfs<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>boot
</span></span></code></pre></div><p>Then we&rsquo;re ready to start DHCP server.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dnsmasq --port<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --conf-file<span style=color:#f92672>=</span>/dev/null <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --dhcp-leasefile<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/dnsmasq.leases <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --dhcp-boot<span style=color:#f92672>=</span>/boot.ipxe <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --dhcp-range<span style=color:#f92672>=</span>10.0.0.2,10.0.0.254 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --dhcp-option<span style=color:#f92672>=</span>option:dns-server,1.1.1.1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --interface<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>lan_if<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-tftp<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>lan_if<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tftp-root<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/tftp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --no-daemon
</span></span></code></pre></div><p>You can boot up your RPi now. After spending time pulling Docker image etc., the RPi should output something in the end like</p><pre tabindex=0><code>+ podman start -a 5d85155c5ed80ebc85badf45766db7e33be2b5c12c0292025fed28f6d7fb1391
/ # 
</code></pre><p>You&rsquo;ve booted your RPi into boot2container with a prebuilt iPXE disk image from boot2ipxe!</p><p>If you&rsquo;re using RPi 3B+, don&rsquo;t worry if boot2container complains about no available network interface and fails to start Apline Linux.
There&rsquo;s a known <a href=https://lore.kernel.org/all/d04bcc45-3471-4417-b30b-5cf9880d785d@i2se.com/>mainline kernel issue</a> for RPi 3B+.
<a href=(http://www.mupuf.org/contact/mupuf.html)>Mupuf</a> found a <a href=https://gitlab.freedesktop.org/gfx-ci/boot2container/-/merge_requests/22>workaround</a> to temporarily disable usb_onboard_hub before it&rsquo;s properly fixed.
But currently the kernel downloaded from boot2container release above is still broken.</p></section><div class=paginator><a class=prev href=https://jpy794.github.io/blog/gsoc-blog-4/><span>&larr;&nbsp;&nbsp;</span><span>Final Blog Post - GSoC '23</span></a>
<a class=next href=https://jpy794.github.io/blog/gsoc-blog-2/><span>Getting Started - GSoC '23</span><span>&nbsp;&nbsp;&rarr;</span></a></div><div class=related-resources><h3>Related Resources</h3><nav><ul><li><a href=/blog/gsoc-blog-2/>Getting Started - GSoC '23</a></li><li><a href=/blog/gsoc-blog-1/>The Project - GSoC '23</a></li></ul></nav></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://jpy794.github.io>jpy794</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script type=text/javascript src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>